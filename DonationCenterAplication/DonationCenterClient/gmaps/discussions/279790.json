[
  {
    "Id": "699463",
    "ThreadId": "279790",
    "Html": "\r\n<p>Hi,</p>\r\n<p><span id=\"result_box\" lang=\"en\"><span></span><span>I wondered</span> <span>if the\r\n</span><span>&nbsp;</span></span><span id=\"result_box\" lang=\"en\"><span>MapControl</span>\r\n</span><span id=\"result_box\" lang=\"en\"><span>can manage several</span> <span>layers</span>\r\n<span>data</span><span>.</span> I<span> need&nbsp;</span><span>to display</span> </span>\r\nseveral <span id=\"result_box\" lang=\"en\"><span>WMS</span> <span>layers</span> <span>\r\nand be able to</span> <span>show or hide</span> <span>as needed.</span></span></p>\r\n<p><span id=\"result_box\" lang=\"en\"><span>From</span> <span>what I saw</span><span>,</span>\r\n<span>MapControl</span> <span>has only</span> 1 <span>MapProvider</span> <span>property</span><span>,</span>\r\n<span>and it is not</span> <span>a</span> <span>collection ...</span> So, is it possible ?</span></p>\r\n",
    "PostedDate": "2011-11-17T02:37:52.647-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "699467",
    "ThreadId": "279790",
    "Html": "<p>create custom provider with different layers and switch between them</p>",
    "PostedDate": "2011-11-17T02:43:01.45-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "700182",
    "ThreadId": "279790",
    "Html": "<p>Ok, I tryed to create a provider witch expose a Layers property.&nbsp;</p>\r\n<p>Layers is a collection of layers and each layer give the url of wms data.</p>\r\n<p>I have overrided the GetTileImage method of my Provider to do the merge of layers into one image. The merge work fine, but I have problem with refresh and cache...</p>\r\n<p>&nbsp;</p>\r\n<p>Tyles should be refresh each time layers visibility changed, even if the map is not pan or zoom...</p>\r\n<p>Can you tell me how I can do that ?</p>\r\n<p>Below, the code of my provider <span id=\"result_box\" class=\"short_text\" lang=\"en\"><span class=\"hps\">for</span> <span class=\"hps\">those interested</span></span>.</p>\r\n<p>\r\n<div style=\"color: black; background-color: white;\">\r\n<pre>\r\n    <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">class</span> WMSLayer\r\n    {\r\n\r\n        <span style=\"color: blue;\">#region</span> Properties\r\n\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">string</span> Url { <span style=\"color: blue;\">get</span>; <span style=\"color: blue;\">set</span>; }\r\n\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">string</span> Token { <span style=\"color: blue;\">get</span>; <span style=\"color: blue;\">set</span>; }\r\n\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">bool</span> IsVisible { <span style=\"color: blue;\">get</span>; <span style=\"color: blue;\">set</span>; }\r\n\r\n        <span style=\"color: blue;\">#endregion</span>\r\n    }\r\n\r\n\r\n    <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">class</span> WMSProvider : GMapProvider\r\n    {\r\n        <span style=\"color: blue;\">#region</span> Constructor\r\n\r\n        <span style=\"color: gray;\">///</span> <span style=\"color: gray;\">&lt;summary&gt;</span>\r\n        <span style=\"color: gray;\">///</span><span style=\"color: green;\"> Default constructor</span>\r\n        <span style=\"color: gray;\">///</span> <span style=\"color: gray;\">&lt;/summary&gt;</span>\r\n        <span style=\"color: blue;\">public</span> WMSProvider()\r\n        {\r\n            Layers = <span style=\"color: blue;\">new</span> ObservableCollection&lt;WMSLayer&gt;();\r\n        }\r\n\r\n        <span style=\"color: blue;\">#endregion</span>\r\n\r\n        <span style=\"color: blue;\">#region</span> Properties\r\n\r\n        <span style=\"color: blue;\">public</span> ObservableCollection&lt;WMSLayer&gt; Layers { <span style=\"color: blue;\">get</span>; <span style=\"color: blue;\">set</span>; }\r\n\r\n        <span style=\"color: blue;\">#endregion</span>\r\n\r\n        <span style=\"color: blue;\">#region</span> GMapProvider Members\r\n\r\n        <span style=\"color: blue;\">readonly</span> Guid id = Guid.NewGuid();\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">override</span> Guid Id\r\n        {\r\n            <span style=\"color: blue;\">get</span>\r\n            {\r\n                <span style=\"color: blue;\">return</span> id;\r\n            }\r\n        }\r\n\r\n        <span style=\"color: blue;\">readonly</span> <span style=\"color: blue;\">string</span> name = <span style=\"color: #a31515;\">\"WMS Provider\"</span>;\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">override</span> <span style=\"color: blue;\">string</span> Name\r\n        {\r\n            <span style=\"color: blue;\">get</span>\r\n            {\r\n                <span style=\"color: blue;\">return</span> name;\r\n            }\r\n        }\r\n\r\n        GMapProvider[] overlays;\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">override</span> GMapProvider[] Overlays\r\n        {\r\n            <span style=\"color: blue;\">get</span>\r\n            {\r\n                <span style=\"color: blue;\">if</span> (overlays == <span style=\"color: blue;\">null</span>)\r\n                {\r\n                    overlays = <span style=\"color: blue;\">new</span> GMapProvider[] { <span style=\"color: blue;\">this</span> };\r\n                }\r\n                <span style=\"color: blue;\">return</span> overlays;\r\n            }\r\n        }\r\n\r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">override</span> PureProjection Projection\r\n        {\r\n            <span style=\"color: blue;\">get</span>\r\n            {\r\n                <span style=\"color: blue;\">return</span> MercatorProjection.Instance;\r\n            }\r\n        }\r\n        \r\n        <span style=\"color: blue;\">public</span> <span style=\"color: blue;\">override</span> PureImage GetTileImage(GPoint pos, <span style=\"color: blue;\">int</span> zoom)\r\n        {\r\n            PureImage result = <span style=\"color: blue;\">null</span>;\r\n\r\n            <span style=\"color: blue;\">foreach</span> (WMSLayer layer <span style=\"color: blue;\">in</span> Layers)\r\n            {\r\n                <span style=\"color: blue;\">if</span> (layer.IsVisible)\r\n                {\r\n                    <span style=\"color: blue;\">string</span> url = MakeTileImageUrl(pos, zoom, layer);\r\n                    PureImage layerImage = <span style=\"color: blue;\">null</span>;\r\n\r\n                    <span style=\"color: blue;\">try</span>\r\n                    {\r\n                        layerImage = GetTileImageUsingHttp(url);\r\n                    }\r\n                    <span style=\"color: blue;\">catch</span> (Exception)\r\n                    {\r\n                        <span style=\"color: green;\">// Todo catch timeout error</span>\r\n                    }\r\n\r\n                    <span style=\"color: blue;\">if</span> (layerImage <span style=\"color: blue;\">is</span> WindowsPresentationImage)\r\n                    {\r\n                        <span style=\"color: blue;\">if</span> (result == <span style=\"color: blue;\">null</span>)\r\n                        {\r\n                            result = layerImage;\r\n                        }\r\n                        <span style=\"color: blue;\">else</span>\r\n                        {\r\n                            <span style=\"color: green;\">// Merge layerImage with previous</span>\r\n                            MemoryStream res = result.Data;\r\n                            Image img = Image.FromStream(result.Data);\r\n\r\n                            <span style=\"color: blue;\">using</span> (Graphics grfx = Graphics.FromImage(img))\r\n                            {\r\n                                grfx.DrawImage(Image.FromStream(layerImage.Data), 0, 0, img.Width, img.Height);\r\n                            }\r\n\r\n                            MemoryStream ms = <span style=\"color: blue;\">new</span> MemoryStream();\r\n                            img.Save(ms, ImageFormat.Png);\r\n                            ms.Position = 0;\r\n                            result.Data = ms;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            <span style=\"color: blue;\">return</span> result;\r\n        }\r\n        \r\n\r\n        <span style=\"color: blue;\">#endregion</span>\r\n\r\n        <span style=\"color: blue;\">#region</span> WMS provider core\r\n        \r\n        <span style=\"color: blue;\">string</span> MakeTileImageUrl(GPoint pos, <span style=\"color: blue;\">int</span> zoom, WMSLayer layer)\r\n        {\r\n            <span style=\"color: blue;\">string</span> result = <span style=\"color: #a31515;\">\"\"</span>;\r\n\r\n            <span style=\"color: blue;\">if</span> (layer != <span style=\"color: blue;\">null</span>)\r\n            {\r\n                <span style=\"color: blue;\">var</span> px1 = Projection.FromTileXYToPixel(pos);\r\n                <span style=\"color: blue;\">var</span> px2 = px1;\r\n\r\n                px1.Offset(0, Projection.TileSize.Height);\r\n                PointLatLng p1 = Projection.FromPixelToLatLng(px1, zoom);\r\n\r\n                px2.Offset(Projection.TileSize.Width, 0);\r\n                PointLatLng p2 = Projection.FromPixelToLatLng(px2, zoom);\r\n\r\n                result = <span style=\"color: blue;\">string</span>.Format(CultureInfo.InvariantCulture, layer.Url + UrlEndFormat, layer.Token, p1.Lng, p1.Lat, p2.Lng, p2.Lat, Projection.TileSize.Width, Projection.TileSize.Height);\r\n            }\r\n\r\n            <span style=\"color: blue;\">return</span> result;\r\n        }\r\n        \r\n        <span style=\"color: blue;\">static</span> <span style=\"color: blue;\">readonly</span> <span style=\"color: blue;\">string</span> UrlEndFormat = <span style=\"color: #a31515;\">\"?LAYERS={0}&amp;TRANSPARENT=true&amp;SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetMap&amp;bbox={1},{2},{3},{4}&amp;width={5}&amp;height={6}&amp;srs=EPSG:4326&amp;format=image/png\"</span>;\r\n \r\n        <span style=\"color: blue;\">#endregion</span>\r\n\r\n    }\r\n</pre>\r\n</div>\r\n</p>",
    "PostedDate": "2011-11-18T06:35:39.043-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "700187",
    "ThreadId": "279790",
    "Html": "<p>..thats not i meaned, and&nbsp;Guid.NewGuid(); will simply trash the local cache.</p>\r\n<p>You need to make different providers for different layer configurations, all the merging will be done automatically</p>",
    "PostedDate": "2011-11-18T06:42:36.453-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "700197",
    "ThreadId": "279790",
    "Html": "<p><span id=\"result_box\" lang=\"en\"><span class=\"hps\">I'm not</span> <span class=\"hps\">sure I understand.</span><br /><br /> <span class=\"hps\">Let's say</span> <span class=\"hps\">I have</span> <span class=\"hps\">three</span> <span class=\"hps\">layers:</span> <span class=\"hps\">A, B and</span> <span class=\"hps\">C</span><br /> <span class=\"hps\">you tell me</span> <span class=\"hps\">to make as many</span> <span class=\"hps\">provider</span> <span class=\"hps\">that there are</span> <span class=\"hps\">possible combinations</span> <span class=\"hps\">between these different</span> <span class=\"hps\">layers :</span><br /> <span class=\"hps\">ProviderA</span> (that display only the layer A), <span class=\"hps\">ProviderB</span><span>,</span> <span class=\"hps\">ProviderC</span><span>,</span> <span class=\"hps\">ProviderAB</span><span>,</span> <span class=\"hps\">ProviderBC</span><span>,</span> <span class=\"hps\">ProviderAC</span><span>,</span> <span class=\"hps\">ProviderABC</span><span>?</span></span></p>\r\n<p><span lang=\"en\"><span>And next to set the Provider property of the MapControl with the good provider according to the visibility state of my layers ?<br /></span></span></p>",
    "PostedDate": "2011-11-18T06:52:43.393-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "700213",
    "ThreadId": "279790",
    "Html": "<p>yes</p>",
    "PostedDate": "2011-11-18T07:23:08.013-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "1429889",
    "ThreadId": "279790",
    "Html": "Hi,\r<br />\n<br />\nI have the same question. Is it possible to have an WMS Provider with different Layers?\r<br />\n<br />\nRegards<br />\n",
    "PostedDate": "2015-06-10T05:40:27.527-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]